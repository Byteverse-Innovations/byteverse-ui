# Track AWS CodePipeline (Byteverse-UI-Pipeline) and report status in GitHub.
# No build in GitHub — CodePipeline does the build/deploy. This workflow only polls
# pipeline status so you can see deploy success/failure in the Actions tab.
#
# Auth (pick one):
#   A) OIDC (recommended): Add secret AWS_ROLE_ARN (IAM role that trusts GitHub OIDC).
#      In AWS: create an OIDC IdP for token.actions.githubusercontent.com, then a role
#      with trust for your repo and codepipeline:ListPipelineExecutions, GetPipelineExecution.
#   B) Long-lived keys: Add secrets AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY, AWS_REGION.
#      If you get "The security token included in the request is invalid": create a new
#      access key in IAM, copy both key and secret with no extra spaces/newlines into
#      GitHub repo secrets; ensure the IAM user has codepipeline read permissions.
name: Track UI Deployment

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  PIPELINE_NAME: Byteverse-UI-Pipeline

jobs:
  track-deployment:
    name: CodePipeline status
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Configure AWS credentials (OIDC)
        if: ${{ secrets.AWS_ROLE_ARN != '' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Configure AWS credentials (access key)
        if: ${{ secrets.AWS_ROLE_ARN == '' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Verify AWS access
        run: |
          aws sts get-caller-identity || (echo "::error::AWS credentials are invalid. Check secrets (no spaces/newlines) or use OIDC (AWS_ROLE_ARN)." && exit 1)

      - name: Wait for pipeline to start
        run: sleep 90
        if: github.event_name == 'push'

      - name: Get latest pipeline execution
        id: get-exec
        run: |
          EXEC=$(aws codepipeline list-pipeline-executions \
            --pipeline-name "$PIPELINE_NAME" \
            --max-items 1 \
            --query 'pipelineExecutionSummaries[0].pipelineExecutionId' \
            --output text 2>/dev/null || echo "")
          if [ -z "$EXEC" ] || [ "$EXEC" = "None" ]; then
            echo "No pipeline execution found. Pipeline may not have started yet."
            echo "execution_id=" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "execution_id=$EXEC" >> $GITHUB_OUTPUT
          echo "Found execution $EXEC"

      - name: Poll pipeline until complete
        id: poll
        run: |
          EXEC="${{ steps.get-exec.outputs.execution_id }}"
          if [ -z "$EXEC" ]; then
            echo "status=NoExecution" >> $GITHUB_OUTPUT
            exit 0
          fi
          TIMEOUT=1800   # 30 min
          ELAPSED=0
          while [ $ELAPSED -lt $TIMEOUT ]; do
            STATUS=$(aws codepipeline get-pipeline-execution \
              --pipeline-name "$PIPELINE_NAME" \
              --pipeline-execution-id "$EXEC" \
              --query 'pipelineExecution.status' \
              --output text)
            echo "Status: $STATUS (${ELAPSED}s)"
            if [ "$STATUS" = "Succeeded" ]; then
              echo "status=Succeeded" >> $GITHUB_OUTPUT
              exit 0
            fi
            if [ "$STATUS" = "Failed" ] || [ "$STATUS" = "Stopped" ] || [ "$STATUS" = "Stopping" ]; then
              echo "status=$STATUS" >> $GITHUB_OUTPUT
              exit 0
            fi
            sleep 60
            ELAPSED=$((ELAPSED + 60))
          done
          echo "status=Timeout" >> $GITHUB_OUTPUT
          exit 0

      - name: Report result
        run: |
          STATUS="${{ steps.poll.outputs.status }}"
          if [ "$STATUS" = "Succeeded" ]; then
            echo "✅ CodePipeline deployment succeeded."
          elif [ "$STATUS" = "NoExecution" ]; then
            echo "⚠️ No pipeline execution found. Run the workflow again or check AWS."
          else
            echo "❌ CodePipeline finished with status: $STATUS"
            exit 1
          fi
